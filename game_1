<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,maximum-scale=1,user-scalable=no" />
  <title>Cyberpunk Hacker Idle Clicker — Commercial-ish Final</title>
  <style>
    :root{
      --bg0:#05060c;
      --bg1:#070a12;

      --pink:#ff2bd6;
      --blue:#25d6ff;
      --lime:#b6ff2b;
      --text:#d7e3ff;
      --bad:#ff3b3b;

      --radius: 18px;
      --shadow:
        0 0 0 1px rgba(255,43,214,0.10) inset,
        0 0 22px rgba(37,214,255,0.12),
        0 0 44px rgba(255,43,214,0.08);
    }

    *{ box-sizing:border-box; }
    html,body{
      margin:0;
      height:100%;
      overflow:hidden;
      overscroll-behavior:none;
      background: radial-gradient(1200px 700px at 60% 10%, #111a35 0%, var(--bg1) 55%, var(--bg0) 100%);
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans KR", Arial, sans-serif;
      user-select:none;
      -webkit-user-select:none;
      touch-action:none;
    }

    /* Background canvas */
    #bg{
      position:fixed;
      inset:0;
      width:100vw;
      height:100vh;
      display:block;
      z-index:0;
    }

    /* Flash overlay (Golden Glitch) */
    .flash{
      position:fixed;
      inset:0;
      pointer-events:none;
      z-index:999;
      opacity:0;
      background:
        radial-gradient(700px 500px at 50% 40%, rgba(255,215,0,0.18), rgba(255,215,0,0)),
        linear-gradient(180deg, rgba(255,255,255,0.08), rgba(0,0,0,0));
      transition: opacity 120ms ease;
    }
    .flash.on{ opacity: 1; }

    /* Layout */
    .app{
      position:relative;
      z-index:1;
      height:100%;
      display:flex;
      gap:14px;
      padding:14px;
      padding-top: calc(14px + env(safe-area-inset-top, 0px));
      padding-bottom: calc(14px + env(safe-area-inset-bottom, 0px));
    }
    .left{
      flex: 0 0 60%;
      min-width: 320px;
      position:relative;
      border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(10,14,28,0.62), rgba(6,8,16,0.38));
      border: 1px solid rgba(37,214,255,0.18);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .right{
      flex: 0 0 40%;
      min-width: 280px;
      border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(10,14,28,0.70), rgba(6,8,16,0.50));
      border: 1px solid rgba(37,214,255,0.18);
      box-shadow: var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }

    /* HUD */
    .hud{
      position:absolute;
      top:14px;
      left:14px;
      right:14px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      pointer-events:none;
      z-index:3;
    }
    .hudCard{
      pointer-events:none;
      padding:12px 14px;
      border-radius: 16px;
      background: linear-gradient(180deg, rgba(10,14,28,0.62), rgba(6,8,16,0.36));
      border: 1px solid rgba(37,214,255,0.15);
      box-shadow:
        0 0 0 1px rgba(255,43,214,0.08) inset,
        0 0 18px rgba(37,214,255,0.10);
      backdrop-filter: blur(6px);
      min-width: 220px;
    }
    .hudLabel{
      font-size: 12px;
      letter-spacing: 0.16em;
      opacity: 0.75;
      margin-bottom: 4px;
    }
    .hudValue{
      font-weight: 900;
      font-size: clamp(24px, 3vw, 34px);
      letter-spacing: 0.04em;
      text-shadow:
        0 0 10px rgba(37,214,255,0.45),
        0 0 14px rgba(255,43,214,0.22);
      transform-origin: 50% 50%;
      will-change: transform;
      transition: transform 120ms ease;
    }
    .hudSub{
      margin-top: 4px;
      font-size: 12px;
      opacity: 0.78;
      letter-spacing: 0.08em;
      text-shadow: 0 0 10px rgba(182,255,43,0.18);
      line-height: 1.35;
    }

    /* SOUND button (top-right overlay) */
    .soundBtn{
      position:fixed;
      top: calc(14px + env(safe-area-inset-top, 0px));
      right: 14px;
      z-index: 1000;
      border: 1px solid rgba(37,214,255,0.22);
      background: rgba(6,8,16,0.55);
      color: rgba(215,227,255,0.92);
      padding: 10px 12px;
      border-radius: 14px;
      font-weight: 900;
      letter-spacing: 0.10em;
      cursor:pointer;
      text-shadow: 0 0 10px rgba(37,214,255,0.20);
      box-shadow:
        0 0 0 1px rgba(255,43,214,0.06) inset,
        0 0 16px rgba(37,214,255,0.10);
      transition: transform 90ms ease, filter 120ms ease, box-shadow 120ms ease;
      -webkit-tap-highlight-color: transparent;
    }
    .soundBtn:hover{
      filter: brightness(1.08);
      box-shadow:
        0 0 18px rgba(37,214,255,0.16),
        0 0 26px rgba(255,43,214,0.08);
      transform: translateY(-1px);
    }
    .soundBtn:active{ transform: translateY(0px) scale(0.98); }

    /* Core */
    .coreWrap{
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 84px 16px 16px;
      z-index:2;
    }
    .coreSystem{
      width: min(560px, 84%);
      aspect-ratio: 1/1;
      position:relative;
      display:flex;
      align-items:center;
      justify-content:center;
      pointer-events:none;
    }
    .satLayer{
      position:absolute;
      inset:0;
      pointer-events:none;
    }
    .coreHitArea{
      width: min(420px, 70%);
      aspect-ratio: 1/1;
      border-radius: 999px;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      touch-action:none;
      position:relative;
      outline:none;
      -webkit-tap-highlight-color: transparent;
      pointer-events:auto;
    }
    .core{
      width:100%;
      height:100%;
      border-radius:999px;
      position:relative;
      transform: scale(1);
      transition: transform 120ms cubic-bezier(.2,.9,.2,1);
      will-change: transform;
      background:
        radial-gradient(circle at 30% 25%, rgba(255,255,255,0.80) 0%, rgba(255,255,255,0.10) 10%, rgba(0,0,0,0) 26%),
        radial-gradient(circle at 50% 50%, rgba(37,214,255,0.18) 0%, rgba(255,43,214,0.14) 35%, rgba(182,255,43,0.06) 55%, rgba(0,0,0,0) 72%),
        radial-gradient(circle at 50% 50%, rgba(0,0,0,0.70) 0%, rgba(0,0,0,0.85) 60%, rgba(0,0,0,0.92) 100%);
      box-shadow:
        0 0 0 2px rgba(37,214,255,0.14) inset,
        0 0 0 1px rgba(255,43,214,0.10),
        0 0 40px rgba(37,214,255,0.22),
        0 0 72px rgba(255,43,214,0.14);
      overflow:hidden;
    }
    .core::before{
      content:"";
      position:absolute;
      inset:-20%;
      background:
        conic-gradient(from 0deg,
          rgba(255,43,214,0.0),
          rgba(255,43,214,0.55),
          rgba(37,214,255,0.55),
          rgba(182,255,43,0.30),
          rgba(255,43,214,0.55),
          rgba(255,43,214,0.0)
        );
      filter: blur(10px);
      opacity: 0.85;
      animation: spin 4.2s linear infinite;
    }
    .core::after{
      content:"";
      position:absolute;
      inset:10%;
      border-radius:999px;
      border: 2px solid rgba(37,214,255,0.22);
      box-shadow:
        0 0 18px rgba(37,214,255,0.18),
        0 0 24px rgba(255,43,214,0.10);
      opacity: 0.9;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .coreCenterText{
      position:absolute;
      inset:0;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:8px;
      z-index:2;
      pointer-events:none;
      text-align:center;
    }
    .coreTitle{
      font-weight: 900;
      letter-spacing: 0.14em;
      font-size: clamp(16px, 2.2vw, 20px);
      opacity: 0.88;
      text-shadow: 0 0 12px rgba(37,214,255,0.35);
    }
    .coreHint{
      font-size: 12px;
      opacity: 0.72;
      letter-spacing: 0.08em;
    }
    .pressed .core{
      transform: scale(0.92);
      transition: transform 90ms cubic-bezier(.2,.8,.2,1);
    }

    /* Satellites */
    .sat{
      position:absolute;
      left:50%;
      top:50%;
      width: 8px;
      height: 8px;
      border-radius: 999px;
      transform: translate(-50%, -50%);
      opacity: 0.95;
      filter: drop-shadow(0 0 10px rgba(255,255,255,0.08));
      will-change: transform, opacity;
    }
    .sat::after{
      content:"";
      position:absolute;
      inset:-6px;
      border-radius:999px;
      background: radial-gradient(circle, rgba(255,255,255,0.30), rgba(0,0,0,0));
      opacity: 0.6;
    }

    /* Floating texts */
    .floatLayer{
      position:absolute;
      inset:0;
      pointer-events:none;
      z-index:4;
    }
    .floatText{
      position:absolute;
      font-weight: 900;
      letter-spacing: 0.04em;
      color: rgba(255,255,255,0.92);
      text-shadow:
        0 0 10px rgba(37,214,255,0.55),
        0 0 14px rgba(255,43,214,0.25);
      transform: translate(-50%, -50%);
      animation: floatUp 780ms cubic-bezier(.2,.9,.2,1) forwards;
      will-change: transform, opacity;
      font-size: 18px;
      opacity: 0.95;
    }
    @keyframes floatUp{
      0%   { transform: translate(-50%, -50%) translateY(0) scale(1);   opacity:0.95; }
      55%  { transform: translate(-50%, -50%) translateY(-26px) scale(1.10); opacity:0.95; }
      100% { transform: translate(-50%, -50%) translateY(-56px) scale(0.95); opacity:0; }
    }

    /* Golden Glitch */
    .glitch{
      position:absolute;
      width: 64px;
      height: 64px;
      border-radius: 18px;
      transform: translate(-50%, -50%) rotate(0deg);
      cursor:pointer;
      pointer-events:auto;
      z-index:6;
      background:
        radial-gradient(circle at 30% 25%, rgba(255,255,255,0.75), rgba(255,255,255,0) 35%),
        linear-gradient(135deg, rgba(255,215,0,0.95), rgba(255,165,0,0.65));
      border: 1px solid rgba(255,215,0,0.35);
      box-shadow:
        0 0 22px rgba(255,215,0,0.28),
        0 0 40px rgba(255,165,0,0.16);
      animation: glitchPulse 1.1s ease-in-out infinite;
      -webkit-tap-highlight-color: transparent;
    }
    .glitch::before{
      content:"";
      position:absolute;
      inset:10px;
      border-radius: 14px;
      background: rgba(5,6,12,0.55);
      box-shadow: 0 0 0 1px rgba(255,215,0,0.20) inset;
    }
    .glitch::after{
      content:"";
      position:absolute;
      left: 50%;
      top: 50%;
      width: 26px;
      height: 26px;
      transform: translate(-50%, -50%) rotate(45deg);
      background:
        conic-gradient(from 0deg,
          rgba(255,215,0,0.0),
          rgba(255,215,0,0.95),
          rgba(255,255,255,0.55),
          rgba(255,215,0,0.95),
          rgba(255,215,0,0.0)
        );
      filter: blur(0.2px);
      box-shadow: 0 0 16px rgba(255,215,0,0.32);
      border-radius: 6px;
      opacity: 0.95;
    }
    @keyframes glitchPulse{
      0%   { transform: translate(-50%, -50%) scale(1.00) rotate(-2deg); filter: brightness(1.00); }
      50%  { transform: translate(-50%, -50%) scale(1.06) rotate(2deg);  filter: brightness(1.10); }
      100% { transform: translate(-50%, -50%) scale(1.00) rotate(-2deg); filter: brightness(1.00); }
    }

    /* Right panel */
    .shopHeader{
      padding: 14px 16px;
      border-bottom: 1px solid rgba(37,214,255,0.14);
      background: linear-gradient(180deg, rgba(10,14,28,0.82), rgba(6,8,16,0.40));
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .shopTitle{
      font-weight: 900;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      font-size: 14px;
      opacity: 0.92;
      text-shadow: 0 0 12px rgba(255,43,214,0.28);
    }
    .shopHint{
      font-size: 12px;
      opacity: 0.72;
      letter-spacing: 0.06em;
      text-align:right;
      line-height:1.25;
    }
    .shopList{
      padding: 12px;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      display:flex;
      flex-direction:column;
      gap: 10px;
    }
    .item{
      border-radius: 16px;
      background: linear-gradient(180deg, rgba(10,14,28,0.62), rgba(6,8,16,0.36));
      border: 1px solid rgba(37,214,255,0.14);
      box-shadow:
        0 0 0 1px rgba(255,43,214,0.07) inset,
        0 0 14px rgba(37,214,255,0.08);
      padding: 12px 12px 12px 14px;
      display:grid;
      grid-template-columns: 1fr auto;
      gap: 10px;
      align-items:center;
    }
    .itemName{
      font-weight: 900;
      letter-spacing: 0.10em;
      font-size: 14px;
      margin-bottom: 6px;
    }
    .itemDesc{
      font-size: 12px;
      opacity: 0.78;
      letter-spacing: 0.06em;
      line-height: 1.35;
    }
    .itemMeta{
      margin-top: 8px;
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      font-size: 12px;
      opacity: 0.86;
      letter-spacing: 0.06em;
    }
    .pill{
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(37,214,255,0.18);
      background: rgba(6,8,16,0.55);
      box-shadow: 0 0 14px rgba(37,214,255,0.06);
      white-space: nowrap;
    }
    .buyBtn{
      border:none;
      padding: 10px 12px;
      border-radius: 14px;
      font-weight: 900;
      letter-spacing: 0.08em;
      font-size: 13px;
      color: rgba(5,6,12,0.96);
      background: linear-gradient(90deg, rgba(255,43,214,0.95), rgba(37,214,255,0.95), rgba(182,255,43,0.90));
      box-shadow:
        0 0 16px rgba(255,43,214,0.24),
        0 0 16px rgba(37,214,255,0.16);
      cursor:pointer;
      transition: transform 90ms ease, filter 90ms ease, box-shadow 120ms ease;
      outline:none;
      -webkit-tap-highlight-color: transparent;
    }
    .buyBtn:hover{
      filter: brightness(1.06);
      box-shadow:
        0 0 22px rgba(255,43,214,0.32),
        0 0 22px rgba(37,214,255,0.22);
      transform: translateY(-1px);
    }
    .buyBtn:active{ transform: translateY(0px) scale(0.98); }
    .buyBtn:disabled{
      cursor:not-allowed;
      filter: grayscale(0.15) brightness(0.85);
      opacity: 0.7;
      box-shadow: none;
    }

    /* Prestige card */
    .rebootCard{
      border-radius: 16px;
      background: linear-gradient(180deg, rgba(255,215,0,0.10), rgba(6,8,16,0.36));
      border: 1px solid rgba(255,215,0,0.25);
      box-shadow:
        0 0 0 1px rgba(255,215,0,0.10) inset,
        0 0 18px rgba(255,215,0,0.10);
      padding: 12px 12px 12px 14px;
      display:grid;
      grid-template-columns: 1fr auto;
      gap: 10px;
      align-items:center;
    }
    .rebootTitle{
      font-weight: 900;
      letter-spacing: 0.14em;
      font-size: 13px;
      margin-bottom: 6px;
      color: rgba(255,235,180,0.96);
      text-shadow: 0 0 12px rgba(255,215,0,0.20);
    }
    .rebootDesc{
      font-size: 12px;
      opacity: 0.86;
      letter-spacing: 0.06em;
      line-height: 1.35;
    }
    .rebootBtn{
      border:none;
      padding: 10px 12px;
      border-radius: 14px;
      font-weight: 900;
      letter-spacing: 0.10em;
      font-size: 12px;
      color: rgba(5,6,12,0.96);
      background: linear-gradient(90deg, rgba(255,215,0,0.95), rgba(255,170,0,0.85));
      box-shadow: 0 0 18px rgba(255,215,0,0.18);
      cursor:pointer;
      transition: transform 90ms ease, filter 90ms ease, box-shadow 120ms ease;
      outline:none;
      -webkit-tap-highlight-color: transparent;
      min-width: 130px;
    }
    .rebootBtn:hover{
      filter: brightness(1.06);
      box-shadow: 0 0 26px rgba(255,215,0,0.26);
      transform: translateY(-1px);
    }
    .rebootBtn:active{ transform: translateY(0px) scale(0.98); }
    .rebootBtn:disabled{
      cursor:not-allowed;
      filter: grayscale(0.20) brightness(0.80);
      opacity: 0.7;
      box-shadow: none;
    }

    /* Reset Data */
    .resetWrap{
      padding: 12px;
      border-top: 1px solid rgba(37,214,255,0.12);
      background: linear-gradient(180deg, rgba(6,8,16,0.40), rgba(6,8,16,0.18));
    }
    .resetBtn{
      width: 100%;
      border: 1px solid rgba(255,59,59,0.35);
      background: rgba(255,59,59,0.10);
      color: rgba(255,220,220,0.92);
      padding: 10px 12px;
      border-radius: 14px;
      font-weight: 900;
      letter-spacing: 0.08em;
      cursor:pointer;
      transition: box-shadow 120ms ease, transform 90ms ease, filter 120ms ease;
      text-shadow: 0 0 10px rgba(255,59,59,0.25);
    }
    .resetBtn:hover{
      filter: brightness(1.08);
      box-shadow:
        0 0 18px rgba(255,59,59,0.20),
        0 0 26px rgba(255,43,214,0.08);
      transform: translateY(-1px);
    }
    .resetBtn:active{ transform: translateY(0px) scale(0.99); }

    /* Terminal (left bottom) */
    .terminal{
      position:absolute;
      left: 14px;
      right: 14px;
      bottom: 14px;
      height: 150px;
      border-radius: 16px;
      background: rgba(0,0,0,0.55);
      border: 1px solid rgba(182,255,43,0.18);
      box-shadow:
        0 0 0 1px rgba(37,214,255,0.05) inset,
        0 0 18px rgba(182,255,43,0.06);
      overflow:hidden;
      z-index:2;
      pointer-events:none;
      backdrop-filter: blur(4px);
    }
    .terminalHeader{
      padding: 10px 12px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-weight: 900;
      letter-spacing: 0.12em;
      font-size: 12px;
      color: rgba(182,255,43,0.92);
      opacity: 0.9;
      border-bottom: 1px solid rgba(182,255,43,0.12);
      background: rgba(0,0,0,0.35);
    }
    .terminalBody{
      padding: 10px 12px;
      display:flex;
      flex-direction:column;
      gap: 6px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      color: rgba(182,255,43,0.92);
      letter-spacing: 0.03em;
    }
    .termLine{
      opacity: 0.95;
      transform: translateY(0);
      animation: termIn 260ms ease-out both;
      will-change: transform, opacity;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    @keyframes termIn{
      from { opacity:0; transform: translateY(6px); }
      to   { opacity:0.95; transform: translateY(0); }
    }
    .termFade{
      animation: termOut 900ms ease-in forwards;
    }
    @keyframes termOut{
      to { opacity:0; transform: translateY(-10px); }
    }

    /* Offline modal */
    .modalOverlay{
      position:fixed;
      inset:0;
      z-index: 2000;
      background: rgba(0,0,0,0.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
    }
    .modalOverlay.show{ display:flex; }
    .modal{
      width: min(520px, 92vw);
      border-radius: 18px;
      background: linear-gradient(180deg, rgba(10,14,28,0.92), rgba(6,8,16,0.72));
      border: 1px solid rgba(37,214,255,0.20);
      box-shadow:
        0 0 0 1px rgba(255,43,214,0.10) inset,
        0 0 28px rgba(37,214,255,0.14);
      padding: 16px 16px 14px;
      backdrop-filter: blur(8px);
    }
    .modalTitle{
      font-weight: 900;
      letter-spacing: 0.14em;
      font-size: 14px;
      margin-bottom: 10px;
      text-shadow: 0 0 14px rgba(37,214,255,0.20);
    }
    .modalMsg{
      opacity: 0.88;
      letter-spacing: 0.06em;
      line-height: 1.45;
      margin-bottom: 12px;
      font-size: 13px;
    }
    .modalActions{
      display:flex;
      justify-content:flex-end;
      gap: 10px;
    }
    .modalBtn{
      border:none;
      padding: 10px 12px;
      border-radius: 14px;
      font-weight: 900;
      letter-spacing: 0.10em;
      font-size: 12px;
      color: rgba(5,6,12,0.96);
      background: linear-gradient(90deg, rgba(37,214,255,0.95), rgba(255,43,214,0.90));
      box-shadow: 0 0 18px rgba(37,214,255,0.14);
      cursor:pointer;
      transition: transform 90ms ease, filter 120ms ease, box-shadow 120ms ease;
      -webkit-tap-highlight-color: transparent;
    }
    .modalBtn:hover{ filter: brightness(1.06); transform: translateY(-1px); }
    .modalBtn:active{ transform: translateY(0px) scale(0.98); }

    @media (max-width: 860px){
      .app{ flex-direction: column; padding: 12px; }
      .left, .right{ flex: 1 1 auto; min-width: 0; }
      .left{ height: 58%; }
      .right{ height: 42%; }
      .coreSystem{ width: min(560px, 95%); }
      .coreHitArea{ width: min(360px, 72%); }
      .glitch{ width: 56px; height: 56px; }
      .rebootBtn{ min-width: 120px; }
      .terminal{ height: 138px; }
      .soundBtn{ right: 12px; top: calc(12px + env(safe-area-inset-top, 0px)); }
    }
  </style>
</head>
<body>
  <canvas id="bg"></canvas>
  <div class="flash" id="flash"></div>

  <button class="soundBtn" id="soundBtn">SOUND OFF</button>

  <div class="app">
    <!-- LEFT -->
    <section class="left" id="left">
      <div class="hud">
        <div class="hudCard">
          <div class="hudLabel">DATA</div>
          <div class="hudValue" id="moneyText">0</div>
          <div class="hudSub" id="gpsText">
            GPS: 0 /s<br/>
            <span id="prestigeText">BIT CORE: 0 (BONUS +0%)</span>
          </div>
        </div>
        <div class="hudCard" style="min-width: 200px; text-align:right;">
          <div class="hudLabel">STATUS</div>
          <div class="hudSub" id="statusText">CORE ONLINE • CLICK TO EXTRACT</div>
        </div>
      </div>

      <div class="coreWrap">
        <div class="coreSystem" id="coreSystem">
          <div class="satLayer" id="satLayer"></div>

          <div class="coreHitArea" id="coreArea" tabindex="0" aria-label="Neon Core">
            <div class="core" id="core"></div>
            <div class="coreCenterText">
              <div class="coreTitle">NEON CORE</div>
              <div class="coreHint">Click / Tap</div>
            </div>
          </div>
        </div>
      </div>

      <div class="floatLayer" id="floatLayer"></div>

      <!-- Terminal -->
      <div class="terminal">
        <div class="terminalHeader">HACK LOG TERMINAL</div>
        <div class="terminalBody" id="terminalBody"></div>
      </div>
    </section>

    <!-- RIGHT -->
    <aside class="right">
      <div class="shopHeader">
        <div class="shopTitle">UPGRADE SHOP</div>
        <div class="shopHint">Price × 1.15<br/>Auto income per second</div>
      </div>

      <div class="shopList" id="shopList"></div>

      <div class="resetWrap">
        <button class="resetBtn" id="resetBtn">데이터 초기화 (Reset Data)</button>
      </div>
    </aside>
  </div>

  <!-- Offline modal -->
  <div class="modalOverlay" id="offlineModal">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="offlineTitle">
      <div class="modalTitle" id="offlineTitle">OFFLINE HACKING REPORT</div>
      <div class="modalMsg" id="offlineMsg">...</div>
      <div class="modalActions">
        <button class="modalBtn" id="offlineConfirm">CONFIRM</button>
      </div>
    </div>
  </div>

<script>
(() => {
  // ============================================================
  // Keys
  // ============================================================
  const SAVE_KEY = "cyber_clicker_final_v4";
  const LAST_SEEN_KEY = "cyber_clicker_last_seen_v4";

  // ============================================================
  // Utils
  // ============================================================
  function rand(a,b){ return a + Math.random()*(b-a); }
  function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }

  // ============================================================
  // Number formatting up to Qa (1e15)
  // ============================================================
  const SUFFIX = [
    { v: 1e15, s: "Qa" },
    { v: 1e12, s: "T"  },
    { v: 1e9,  s: "B"  },
    { v: 1e6,  s: "M"  },
    { v: 1e3,  s: "k"  },
  ];
  function format(n){
    if(!isFinite(n)) return "0";
    const abs = Math.abs(n);
    if(abs < 1000) return String(Math.floor(n));
    for(const u of SUFFIX){
      if(abs >= u.v){
        const val = n / u.v;
        let d = 2;
        if(Math.abs(val) >= 100) d = 0;
        else if(Math.abs(val) >= 10) d = 1;
        const out = val.toFixed(d).replace(/\.0+$/,"").replace(/(\.\d*[1-9])0+$/,"$1");
        return out + u.s;
      }
    }
    return String(Math.floor(n));
  }

  function formatTime(totalSeconds){
    totalSeconds = Math.max(0, Math.floor(totalSeconds));
    const h = Math.floor(totalSeconds / 3600);
    const m = Math.floor((totalSeconds % 3600) / 60);
    return { h, m };
  }

  // ============================================================
  // UI refs
  // ============================================================
  const ui = {
    bg: document.getElementById('bg'),
    flash: document.getElementById('flash'),
    soundBtn: document.getElementById('soundBtn'),

    moneyText: document.getElementById("moneyText"),
    gpsText: document.getElementById("gpsText"),
    prestigeText: document.getElementById("prestigeText"),
    statusText: document.getElementById("statusText"),

    coreArea: document.getElementById("coreArea"),
    left: document.getElementById("left"),
    floatLayer: document.getElementById("floatLayer"),

    shopList: document.getElementById("shopList"),
    resetBtn: document.getElementById("resetBtn"),

    satLayer: document.getElementById("satLayer"),
    coreSystem: document.getElementById("coreSystem"),

    terminalBody: document.getElementById("terminalBody"),

    offlineModal: document.getElementById("offlineModal"),
    offlineMsg: document.getElementById("offlineMsg"),
    offlineConfirm: document.getElementById("offlineConfirm"),
  };

  // ============================================================
  // Terminal log
  // ============================================================
  const terminal = {
    lines: [],
    max: 8
  };

  function termPush(text){
    const now = new Date();
    const stamp = now.toLocaleTimeString([], { hour:'2-digit', minute:'2-digit', second:'2-digit' });
    terminal.lines.push({ text: `[${stamp}] ${text}`, created: performance.now() });
    while(terminal.lines.length > terminal.max) terminal.lines.shift();
    renderTerminal();
  }

  function renderTerminal(){
    ui.terminalBody.innerHTML = "";
    // newest at bottom
    terminal.lines.forEach((l, idx) => {
      const el = document.createElement("div");
      el.className = "termLine";
      el.textContent = l.text;

      // 오래된 줄은 더 투명하게
      const ageRank = (terminal.lines.length - 1 - idx);
      const base = 0.92;
      const op = clamp(base - ageRank * 0.10, 0.22, 0.92);
      el.style.opacity = String(op);

      ui.terminalBody.appendChild(el);
    });
  }

  const randomPhrases = [
    "Bypassing Firewall...",
    "Tracing IP...",
    "Decrypting Packet Stream...",
    "Mining Block #"+Math.floor(rand(1000,9999))+"...",
    "Spoofing MAC Address...",
    "Injecting Payload...",
    "Escalating Privileges...",
    "Scanning Open Ports...",
    "Scraping Darknet Nodes...",
    "Routing Through Proxy Chain..."
  ];
  let lastRandomLogAt = performance.now();
  function tickRandomLog(now){
    if(now - lastRandomLogAt >= 5000){
      lastRandomLogAt = now;
      termPush(randomPhrases[(Math.random()*randomPhrases.length)|0]);
    }
  }

  // ============================================================
  // Audio (Web Audio API)
  //  - BGM: dark drone (saw + lowpass)
  //  - SFX: click tick, buy chime, glitch warning
  //  - User gesture required to start AudioContext
  // ============================================================
  const audio = {
    ctx: null,
    master: null,
    bgGain: null,
    droneOsc: null,
    droneFilter: null,
    enabled: false,
    started: false,
  };

  function ensureAudio(){
    if(audio.ctx) return;
    const AC = window.AudioContext || window.webkitAudioContext;
    audio.ctx = new AC();

    audio.master = audio.ctx.createGain();
    audio.master.gain.value = 0.0; // start muted (OFF)
    audio.master.connect(audio.ctx.destination);

    // Drone chain
    audio.droneFilter = audio.ctx.createBiquadFilter();
    audio.droneFilter.type = "lowpass";
    audio.droneFilter.frequency.value = 220; // low, dark
    audio.droneFilter.Q.value = 0.9;

    audio.bgGain = audio.ctx.createGain();
    audio.bgGain.gain.value = 0.10; // very low

    audio.droneFilter.connect(audio.bgGain);
    audio.bgGain.connect(audio.master);

    // Drone oscillator
    audio.droneOsc = audio.ctx.createOscillator();
    audio.droneOsc.type = "sawtooth";
    audio.droneOsc.frequency.value = 48; // low fundamental

    // gentle LFO for filter drift
    const lfo = audio.ctx.createOscillator();
    lfo.type = "sine";
    lfo.frequency.value = 0.08;

    const lfoGain = audio.ctx.createGain();
    lfoGain.gain.value = 70; // mod depth
    lfo.connect(lfoGain);
    lfoGain.connect(audio.droneFilter.frequency);

    audio.droneOsc.connect(audio.droneFilter);

    audio.droneOsc.start();
    lfo.start();

    audio.started = true;
  }

  function setSound(on){
    ensureAudio();
    audio.enabled = on;

    // resume context if needed
    if(audio.ctx.state === "suspended"){
      audio.ctx.resume().catch(()=>{});
    }

    const t = audio.ctx.currentTime;
    const target = on ? 0.9 : 0.0;
    audio.master.gain.cancelScheduledValues(t);
    audio.master.gain.setTargetAtTime(target, t, 0.04);

    ui.soundBtn.textContent = on ? "SOUND ON" : "SOUND OFF";
  }

  function playTick(){
    if(!audio.enabled || !audio.ctx) return;
    const t = audio.ctx.currentTime;

    const o = audio.ctx.createOscillator();
    const g = audio.ctx.createGain();
    const f = audio.ctx.createBiquadFilter();

    o.type = "square";
    o.frequency.setValueAtTime(1200, t);
    o.frequency.exponentialRampToValueAtTime(820, t + 0.03);

    f.type = "highpass";
    f.frequency.value = 600;

    g.gain.setValueAtTime(0.0001, t);
    g.gain.exponentialRampToValueAtTime(0.12, t + 0.005);
    g.gain.exponentialRampToValueAtTime(0.0001, t + 0.06);

    o.connect(f);
    f.connect(g);
    g.connect(audio.master);

    o.start(t);
    o.stop(t + 0.07);
  }

  function playChime(){
    if(!audio.enabled || !audio.ctx) return;
    const t = audio.ctx.currentTime;

    const notes = [880, 1320, 1760]; // bright
    notes.forEach((hz, i) => {
      const o = audio.ctx.createOscillator();
      const g = audio.ctx.createGain();
      o.type = "sine";
      const tt = t + i*0.03;
      o.frequency.setValueAtTime(hz, tt);

      g.gain.setValueAtTime(0.0001, tt);
      g.gain.exponentialRampToValueAtTime(0.12, tt + 0.01);
      g.gain.exponentialRampToValueAtTime(0.0001, tt + 0.20);

      o.connect(g);
      g.connect(audio.master);
      o.start(tt);
      o.stop(tt + 0.22);
    });
  }

  function playGlitchWarn(){
    if(!audio.enabled || !audio.ctx) return;
    const t = audio.ctx.currentTime;

    const o = audio.ctx.createOscillator();
    const g = audio.ctx.createGain();
    const f = audio.ctx.createBiquadFilter();

    o.type = "sawtooth";
    o.frequency.setValueAtTime(320, t);
    o.frequency.exponentialRampToValueAtTime(180, t + 0.18);

    f.type = "bandpass";
    f.frequency.setValueAtTime(900, t);
    f.Q.value = 4;

    g.gain.setValueAtTime(0.0001, t);
    g.gain.exponentialRampToValueAtTime(0.14, t + 0.02);
    g.gain.exponentialRampToValueAtTime(0.0001, t + 0.22);

    // slight frequency jitter
    const jitter = audio.ctx.createOscillator();
    jitter.type = "square";
    jitter.frequency.value = 22;
    const jg = audio.ctx.createGain();
    jg.gain.value = 22;
    jitter.connect(jg);
    jg.connect(o.frequency);

    o.connect(f);
    f.connect(g);
    g.connect(audio.master);

    jitter.start(t);
    o.start(t);
    o.stop(t + 0.24);
    jitter.stop(t + 0.24);
  }

  // SOUND button
  ui.soundBtn.addEventListener("click", (e) => {
    e.preventDefault();
    // toggle
    const next = !audio.enabled;
    setSound(next);
    termPush(next ? "Audio system ONLINE." : "Audio system MUTED.");
  });

  // First user gesture: start audio if user clicks anywhere meaningful (core/left/right)
  function userGestureStartAudio(){
    ensureAudio();
    if(audio.ctx.state === "suspended"){
      audio.ctx.resume().catch(()=>{});
    }
    // do not auto enable sound; keep current state. But we can start context.
    document.removeEventListener("pointerdown", userGestureStartAudio, { capture:true });
    document.removeEventListener("touchstart", userGestureStartAudio, { capture:true });
  }
  document.addEventListener("pointerdown", userGestureStartAudio, { capture:true, passive:false });
  document.addEventListener("touchstart", userGestureStartAudio, { capture:true, passive:false });

  // ============================================================
  // Game data
  // ============================================================
  const PRESTIGE_UNLOCK = 1_000_000;

  const game = {
    money: 0,
    shownMoney: 0,
    gps: 0,
    clickValue: 1,
    lastTick: performance.now(),
    priceMult: 1.15,

    bitCore: 0,
    get multiplier(){ return 1 + 0.10 * this.bitCore; },

    upgrades: [
      { id:"kid",   name:"스크립트 키디",    baseCost:15,      cost:15,      owned:0, gps:1,     desc:"1초마다 자동으로 +1 데이터 수집" },
      { id:"farm",  name:"서버 팜",        baseCost:100,     cost:100,     owned:0, gps:5,     desc:"1초마다 자동으로 +5 데이터" },
      { id:"ai",    name:"AI 퀀텀 봇",      baseCost:1000,    cost:1000,    owned:0, gps:50,    desc:"1초마다 자동으로 +50 데이터" },
      { id:"nn",    name:"뉴럴 네트워크",    baseCost:12000,   cost:12000,   owned:0, gps:450,   desc:"딥러닝 기반 자동 침투 • +450/s" },
      { id:"beam",  name:"위성 해킹 빔",     baseCost:150000,  cost:150000,  owned:0, gps:3200,  desc:"궤도 위성 신호 탈취 • +3,200/s" },
      { id:"dark",  name:"다크웹 AI",       baseCost:2000000, cost:2000000, owned:0, gps:15000, desc:"심연의 데이터 마이닝 • +15,000/s" },
    ]
  };

  function baseGPS(){
    let g = 0;
    for(const u of game.upgrades) g += u.owned * u.gps;
    return g;
  }
  function recomputeGPS(){
    game.gps = baseGPS() * game.multiplier;
  }

  // ============================================================
  // Save / Load (+ last seen timestamp)
  // ============================================================
  function saveGame(){
    try{
      const payload = {
        money: game.money,
        bitCore: game.bitCore,
        upgrades: game.upgrades.map(u => ({ id:u.id, owned:u.owned, cost:u.cost })),
        soundEnabled: audio.enabled ? 1 : 0
      };
      localStorage.setItem(SAVE_KEY, JSON.stringify(payload));
      localStorage.setItem(LAST_SEEN_KEY, String(Date.now()));
      ui.statusText.textContent = "AUTO-SAVED • DATA ENCRYPTED";
    }catch(e){
      ui.statusText.textContent = "SAVE FAILED • STORAGE BLOCKED";
    }
  }

  function loadGame(){
    let loaded = false;
    try{
      const raw = localStorage.getItem(SAVE_KEY);
      if(raw){
        const data = JSON.parse(raw);

        if(typeof data.money === "number" && isFinite(data.money)) game.money = Math.max(0, data.money);
        if(typeof data.bitCore === "number" && isFinite(data.bitCore)) game.bitCore = Math.max(0, Math.floor(data.bitCore));

        if(Array.isArray(data.upgrades)){
          for(const s of data.upgrades){
            const u = game.upgrades.find(x => x.id === s.id);
            if(!u) continue;
            if(typeof s.owned === "number" && isFinite(s.owned)) u.owned = Math.max(0, Math.floor(s.owned));
            if(typeof s.cost === "number" && isFinite(s.cost)) u.cost = Math.max(1, Math.floor(s.cost));
          }
        }

        // sound state restore (but still requires user to enable)
        if(typeof data.soundEnabled === "number"){
          // we keep OFF by default visually until user toggles;
          // but store preference for convenience:
          const preferOn = data.soundEnabled === 1;
          // do not auto start sound without gesture; just set button text after first enable possible.
          // We'll apply after ensureAudio via setSound when user clicks SOUND btn / or first click optional.
          ui.soundBtn.textContent = preferOn ? "SOUND OFF" : "SOUND OFF";
          audio.enabled = false; // always start OFF, per requirement.
          audio._preferredOn = preferOn;
        }

        loaded = true;
      }
    }catch(e){ /* ignore */ }

    game.shownMoney = game.money;
    recomputeGPS();
    if(loaded) ui.statusText.textContent = "SAVE LOADED • WELCOME BACK";
    return loaded;
  }

  // ============================================================
  // Offline Progress (0.5 penalty)
  //  - Uses current GPS at load time (after loading upgrades/bitcore)
  // ============================================================
  function applyOfflineProgress(){
    const lastSeenRaw = localStorage.getItem(LAST_SEEN_KEY);
    const nowTs = Date.now();
    if(!lastSeenRaw) return;

    const lastTs = Number(lastSeenRaw);
    if(!isFinite(lastTs) || lastTs <= 0) return;

    const elapsedSec = Math.max(0, (nowTs - lastTs) / 1000);
    if(elapsedSec < 8) return; // too small -> ignore

    const reward = Math.floor(elapsedSec * game.gps * 0.5);
    if(reward <= 0) return;

    const { h, m } = formatTime(elapsedSec);
    ui.offlineMsg.textContent = `${format(h)}시간 ${format(m)}분 동안 ${format(reward)} Data를 채굴했습니다.`;
    ui.offlineModal.classList.add("show");

    // confirm -> grant
    const grant = () => {
      ui.offlineModal.classList.remove("show");
      game.money += reward;
      game.shownMoney = game.money; // 즉시 반영
      ui.moneyText.style.transform = "scale(1.10)";
      setTimeout(()=> ui.moneyText.style.transform = "scale(1)", 140);
      ui.statusText.textContent = `OFFLINE PROFIT • +${format(reward)} DATA`;
      termPush(`Offline report processed. +${format(reward)} DATA`);
      saveGame();
      ui.offlineConfirm.removeEventListener("click", grant);
      ui.offlineModal.removeEventListener("click", overlayClose);
    };

    const overlayClose = (e) => {
      if(e.target === ui.offlineModal) grant();
    };

    ui.offlineConfirm.addEventListener("click", grant);
    ui.offlineModal.addEventListener("click", overlayClose);
  }

  // ============================================================
  // Floating text + core press
  // ============================================================
  function spawnFloatText(clientX, clientY, text){
    const rect = ui.left.getBoundingClientRect();
    const x = clientX - rect.left;
    const y = clientY - rect.top;

    const el = document.createElement("div");
    el.className = "floatText";
    el.textContent = text;

    el.style.left = (x + rand(-6,6)) + "px";
    el.style.top  = (y + rand(-6,6)) + "px";

    const r = Math.random();
    if(r < 0.33) el.style.textShadow = "0 0 10px rgba(37,214,255,0.55), 0 0 14px rgba(255,43,214,0.25)";
    else if(r < 0.66) el.style.textShadow = "0 0 10px rgba(255,43,214,0.55), 0 0 14px rgba(37,214,255,0.20)";
    else el.style.textShadow = "0 0 10px rgba(182,255,43,0.45), 0 0 14px rgba(37,214,255,0.20)";

    ui.floatLayer.appendChild(el);
    el.addEventListener("animationend", () => el.remove());
  }

  let pressTimer = null;
  function setPressed(){
    ui.coreArea.classList.add("pressed");
    if(pressTimer) clearTimeout(pressTimer);
    pressTimer = setTimeout(() => ui.coreArea.classList.remove("pressed"), 110);
  }

  // ============================================================
  // Satellites
  // ============================================================
  const satConfig = {
    kid:  { color:"rgba(182,255,43,0.95)", glow:"rgba(182,255,43,0.65)", baseR: 138, speed: 0.95, size:7,  layerStep: 10 },
    farm: { color:"rgba(37,214,255,0.95)", glow:"rgba(37,214,255,0.65)", baseR: 172, speed: 0.72, size:8,  layerStep: 11 },
    ai:   { color:"rgba(255,43,214,0.95)", glow:"rgba(255,43,214,0.65)", baseR: 206, speed: 0.56, size:9,  layerStep: 12 },
    nn:   { color:"rgba(170,120,255,0.95)", glow:"rgba(170,120,255,0.70)", baseR: 244, speed: 0.46, size:9,  layerStep: 13 },
    beam: { color:"rgba(255,80,80,0.95)",   glow:"rgba(255,80,80,0.70)",   baseR: 284, speed: 0.36, size:10, layerStep: 14 },
    dark: { color:"rgba(30,30,38,0.92)",    glow:"rgba(150,150,170,0.22)", baseR: 326, speed: 0.28, size:10, layerStep: 15 },
  };

  const sats = [];
  function rebuildSatellites(){
    ui.satLayer.innerHTML = "";
    sats.length = 0;

    const sysW = ui.coreSystem.clientWidth;
    const sysH = ui.coreSystem.clientHeight;
    const scale = clamp(Math.min(sysW, sysH) / 560, 0.78, 1.08);
    const maxR = (Math.min(sysW, sysH) * 0.49);

    for(const u of game.upgrades){
      const cfg = satConfig[u.id];
      if(!cfg) continue;

      const maxPerType = 70;
      const count = Math.min(u.owned, maxPerType);
      const perLayer = 12;

      for(let i=0;i<count;i++){
        const layer = Math.floor(i / perLayer);
        const radius = clamp((cfg.baseR + layer * cfg.layerStep) * scale + rand(-5,5), 90, maxR);

        const el = document.createElement("div");
        el.className = "sat";
        el.style.background = cfg.color;
        el.style.boxShadow = `0 0 12px ${cfg.glow}, 0 0 22px ${cfg.glow}`;
        el.style.width = cfg.size + "px";
        el.style.height = cfg.size + "px";

        if(u.id === "dark"){
          el.style.boxShadow = `0 0 10px rgba(120,120,140,0.18), 0 0 18px rgba(0,0,0,0.35)`;
          el.style.border = "1px solid rgba(200,200,220,0.08)";
        }

        ui.satLayer.appendChild(el);

        const squashX = 1.02 + rand(-0.02, 0.02);
        const squashY = 0.86 + rand(-0.03, 0.03);

        sats.push({
          el,
          type: u.id,
          radius,
          speed: cfg.speed * (0.85 + Math.random()*0.35),
          phase: rand(0, Math.PI*2),
          squashX, squashY
        });
      }
    }
  }

  function updateSatellites(t){
    if(sats.length === 0) return;
    const cx = ui.coreSystem.clientWidth / 2;
    const cy = ui.coreSystem.clientHeight / 2;

    for(const s of sats){
      const ang = s.phase + t * s.speed;

      const rx = s.radius * s.squashX;
      const ry = s.radius * s.squashY;

      const x = cx + Math.cos(ang) * rx;
      const y = cy + Math.sin(ang) * ry;

      const pulse = 0.65 + 0.35 * Math.sin(t * 3.2 + s.phase);
      let op = 0.55 + 0.45 * pulse;
      if(s.type === "dark") op = 0.40 + 0.30 * pulse;

      s.el.style.opacity = String(op);
      s.el.style.transform = `translate(${x}px, ${y}px) translate(-50%, -50%)`;
    }
  }

  // ============================================================
  // Prestige
  // ============================================================
  function calcPrestigeGain(money){
    const v = Math.max(0, money) / PRESTIGE_UNLOCK;
    return Math.floor(Math.sqrt(v));
  }
  function prestigeBonusPercent(){
    return Math.floor(game.bitCore * 10);
  }
  function updatePrestigeHUD(){
    ui.prestigeText.textContent = `BIT CORE: ${game.bitCore} (BONUS +${prestigeBonusPercent()}%)`;
  }

  function fullResetAllKeepBitCore(){
    game.money = 0;
    game.shownMoney = 0;
    for(const u of game.upgrades){
      u.owned = 0;
      u.cost = u.baseCost;
    }
    recomputeGPS();
  }

  function doReboot(){
    const gain = calcPrestigeGain(game.money);
    if(gain <= 0) return;

    termPush("SYSTEM REBOOT INITIATED...");
    const ok = confirm(
      `SYSTEM REBOOT을 실행할까요?\n\n` +
      `획득 비트 코어: +${gain}\n` +
      `리부트 후: Data/업그레이드 초기화\n` +
      `영구 보너스: 비트 코어 1개당 GPS +10%\n`
    );
    if(!ok){
      termPush("SYSTEM REBOOT ABORTED.");
      return;
    }

    game.bitCore += gain;
    fullResetAllKeepBitCore();
    rebuildSatellites();
    recomputeGPS();

    ui.moneyText.style.transform = "scale(1.12)";
    setTimeout(()=> ui.moneyText.style.transform = "scale(1)", 160);

    ui.statusText.textContent = `SYSTEM REBOOT COMPLETE • BIT CORE +${gain}`;
    termPush(`Reboot complete. BIT CORE +${gain}.`);

    saveGame();
    renderShop();
  }

  // ============================================================
  // Golden Glitch
  // ============================================================
  function flashScreen(){
    ui.flash.classList.add("on");
    setTimeout(() => ui.flash.classList.remove("on"), 140);
    setTimeout(() => ui.flash.classList.add("on"), 260);
    setTimeout(() => ui.flash.classList.remove("on"), 380);
  }

  const glitch = { el:null, active:false, despawnAt:0, nextSpawnAt:0 };

  function scheduleNextGlitch(now){
    glitch.nextSpawnAt = now + rand(30000, 60000);
  }

  function spawnGlitch(now){
    if(glitch.active) return;

    const rect = ui.left.getBoundingClientRect();
    const pad = 80;
    const x = rand(pad, rect.width - pad);
    const y = rand(120, rect.height - pad);

    const el = document.createElement("div");
    el.className = "glitch";
    el.style.left = x + "px";
    el.style.top  = y + "px";

    el.addEventListener("mousedown", (e) => {
      e.preventDefault();
      clickGlitch(performance.now());
    });
    el.addEventListener("touchstart", (e) => {
      if(e.cancelable) e.preventDefault();
      clickGlitch(performance.now());
    }, { passive:false });

    ui.left.appendChild(el);
    glitch.el = el;
    glitch.active = true;
    glitch.despawnAt = now + 10000;

    ui.statusText.textContent = "ANOMALY DETECTED • GOLDEN GLITCH!";
    termPush("Warning: Golden Glitch detected.");
    playGlitchWarn();
  }

  function despawnGlitch(){
    if(glitch.el) glitch.el.remove();
    glitch.el = null;
    glitch.active = false;
  }

  function clickGlitch(now){
    if(!glitch.active) return;

    const reward = Math.max(1, Math.floor(game.gps * 120));
    game.money += reward;

    flashScreen();
    ui.moneyText.style.transform = "scale(1.12)";
    setTimeout(()=> ui.moneyText.style.transform = "scale(1)", 140);

    const rect = ui.left.getBoundingClientRect();
    spawnFloatText(rect.left + rect.width*0.5, rect.top + rect.height*0.36, "SYSTEM HACKED!");
    spawnFloatText(rect.left + rect.width*0.5, rect.top + rect.height*0.36 + 18, `HUGE GAIN! +${format(reward)}`);

    ui.statusText.textContent = `SYSTEM HACKED! HUGE GAIN • +${format(reward)} DATA`;
    termPush(`Glitch exploited. +${format(reward)} DATA`);

    saveGame();
    despawnGlitch();
    scheduleNextGlitch(now);
  }

  // ============================================================
  // Shop rendering (includes prestige card)
  // ============================================================
  function renderShop(){
    ui.shopList.innerHTML = "";

    // Prestige card
    const gain = calcPrestigeGain(game.money);
    const unlocked = game.money >= PRESTIGE_UNLOCK;

    const card = document.createElement("div");
    card.className = "rebootCard";

    const left = document.createElement("div");
    const t = document.createElement("div");
    t.className = "rebootTitle";
    t.textContent = "SYSTEM REBOOT";

    const d = document.createElement("div");
    d.className = "rebootDesc";
    d.textContent = unlocked
      ? `지금 리부트하면 비트 코어 +${gain} 획득 가능 • 영구 GPS 보너스 +${prestigeBonusPercent()}%`
      : `해금 조건: DATA ${format(PRESTIGE_UNLOCK)} 이상 • (리부트 시 Bit Core 획득)`;

    left.appendChild(t);
    left.appendChild(d);

    const btn = document.createElement("button");
    btn.className = "rebootBtn";
    btn.textContent = unlocked ? `REBOOT (+${gain})` : "LOCKED";
    btn.disabled = !unlocked || gain <= 0;

    btn.addEventListener("click", () => {
      if(btn.disabled) return;
      doReboot();
    });

    card.appendChild(left);
    card.appendChild(btn);
    ui.shopList.appendChild(card);

    // Upgrades
    for(const u of game.upgrades){
      const row = document.createElement("div");
      row.className = "item";

      const L = document.createElement("div");

      const name = document.createElement("div");
      name.className = "itemName";
      name.textContent = u.name;

      const desc = document.createElement("div");
      desc.className = "itemDesc";
      desc.textContent = u.desc;

      const meta = document.createElement("div");
      meta.className = "itemMeta";
      meta.innerHTML = `
        <span class="pill">Owned: <b>${u.owned}</b></span>
        <span class="pill">+${format(u.gps)}/s</span>
        <span class="pill">Cost: <b>${format(u.cost)}</b></span>
      `;

      L.appendChild(name);
      L.appendChild(desc);
      L.appendChild(meta);

      const buy = document.createElement("button");
      buy.className = "buyBtn";
      buy.textContent = "BUY";
      buy.disabled = game.money < u.cost;

      buy.addEventListener("click", () => {
        if(game.money < u.cost) return;

        game.money -= u.cost;
        u.owned += 1;
        u.cost = Math.ceil(u.cost * game.priceMult);

        recomputeGPS();
        updatePrestigeHUD();

        ui.statusText.textContent = `UPGRADE INSTALLED • ${u.name} x${u.owned}`;
        termPush(`Purchased ${u.name}... OK`);
        playChime();

        ui.moneyText.style.transform = "scale(1.08)";
        setTimeout(()=> ui.moneyText.style.transform = "scale(1)", 120);

        rebuildSatellites();
        saveGame();
        renderShop();
      });

      row.appendChild(L);
      row.appendChild(buy);
      ui.shopList.appendChild(row);
    }
  }

  // ============================================================
  // Core click handling (+ tick SFX)
  // ============================================================
  function doClick(clientX, clientY){
    game.money += game.clickValue;
    setPressed();
    spawnFloatText(clientX, clientY, `+${game.clickValue}`);
    ui.statusText.textContent = "DATA EXTRACTED • SIGNAL BOOSTED";
    playTick();

    // optional: if user previously preferred sound ON, we can auto-enable on first click (still user gesture).
    if(audio._preferredOn && !audio.enabled){
      setSound(true);
      audio._preferredOn = false;
      termPush("Audio preference restored: ON");
    }
  }

  ui.coreArea.addEventListener("mousedown", (e) => {
    e.preventDefault();
    doClick(e.clientX, e.clientY);
  });

  ui.coreArea.addEventListener("touchstart", (e) => {
    if(e.cancelable) e.preventDefault();
    const t = e.touches && e.touches[0];
    if(!t) return;
    doClick(t.clientX, t.clientY);
  }, { passive:false });

  ui.coreArea.addEventListener("keydown", (e) => {
    if(e.code === "Space" || e.code === "Enter"){
      e.preventDefault();
      const rect = ui.coreArea.getBoundingClientRect();
      doClick(rect.left + rect.width/2, rect.top + rect.height/2);
    }
  });

  // Prevent pull-to-refresh / scroll
  document.addEventListener("touchmove", (e)=> { if(e.cancelable) e.preventDefault(); }, { passive:false });

  // ============================================================
  // Reset Data (includes bitCore + sound preference)
  // ============================================================
  ui.resetBtn.addEventListener("click", () => {
    const ok = confirm("정말 데이터를 초기화할까요?\n(보유 Data, 아이템 Owned/Cost, Bit Core까지 모두 초기화됩니다)");
    if(!ok) return;

    localStorage.removeItem(SAVE_KEY);
    localStorage.removeItem(LAST_SEEN_KEY);

    game.bitCore = 0;
    game.money = 0;
    game.shownMoney = 0;

    for(const u of game.upgrades){
      u.owned = 0;
      u.cost = u.baseCost;
    }
    recomputeGPS();
    rebuildSatellites();
    renderShop();
    updatePrestigeHUD();

    ui.statusText.textContent = "RESET COMPLETE • NEW SESSION";
    termPush("All data wiped. New session started.");
  });

  window.addEventListener("beforeunload", () => saveGame());

  // ============================================================
  // Background canvas (matrix + dust)
  // ============================================================
  const bctx = ui.bg.getContext('2d', { alpha: true });
  let W=0, H=0, DPR=1;

  function resize(){
    DPR = Math.min(2, window.devicePixelRatio || 1);
    W = Math.floor(window.innerWidth);
    H = Math.floor(window.innerHeight);
    ui.bg.width = Math.floor(W * DPR);
    ui.bg.height = Math.floor(H * DPR);
    ui.bg.style.width = W + "px";
    ui.bg.style.height = H + "px";
    bctx.setTransform(DPR,0,0,DPR,0,0);
  }
  window.addEventListener('resize', resize);
  resize();

  const matrixCols = [];
  function resetMatrix(){
    matrixCols.length = 0;
    const colW = 16;
    const count = Math.ceil(W / colW);
    for(let i=0;i<count;i++){
      matrixCols.push({
        x: i * colW + rand(-6,6),
        y: rand(-H, 0),
        speed: rand(1.2, 3.5),
        len: rand(10, 28)
      });
    }
  }
  resetMatrix();
  window.addEventListener('resize', resetMatrix);

  const dust = [];
  function resetDust(){
    dust.length = 0;
    const n = Math.min(170, Math.floor((W*H)/10500));
    for(let i=0;i<n;i++){
      dust.push({
        x: rand(0,W), y: rand(0,H),
        vx: rand(-0.15,0.15), vy: rand(-0.10,0.10),
        r: rand(0.6, 1.8),
        a: rand(0.15,0.45),
        c: (Math.random()<0.5) ? "rgba(37,214,255," : "rgba(255,43,214,"
      });
    }
  }
  resetDust();
  window.addEventListener('resize', resetDust);

  function drawBackground(){
    bctx.fillStyle = "rgba(0,0,0,0.20)";
    bctx.fillRect(0,0,W,H);

    bctx.save();
    bctx.font = "12px monospace";
    bctx.textAlign = "center";
    for(const col of matrixCols){
      col.y += col.speed;
      if(col.y - col.len*14 > H + 40){
        col.y = rand(-H, -40);
        col.speed = rand(1.2, 3.5);
        col.len = rand(10, 28);
      }
      for(let i=0;i<col.len;i++){
        const y = col.y - i*14;
        if(y < -20 || y > H + 20) continue;
        const head = i === 0;
        const a = head ? 0.22 : 0.08;
        bctx.fillStyle = head ? `rgba(182,255,43,${a})` : `rgba(37,214,255,${a})`;
        const ch = String.fromCharCode(0x30A0 + ((Math.random()*96)|0));
        bctx.fillText(ch, col.x, y);
      }
    }
    bctx.restore();

    for(const p of dust){
      p.x += p.vx;
      p.y += p.vy;
      if(p.x < -10) p.x = W+10;
      if(p.x > W+10) p.x = -10;
      if(p.y < -10) p.y = H+10;
      if(p.y > H+10) p.y = -10;

      bctx.beginPath();
      bctx.arc(p.x, p.y, p.r, 0, Math.PI*2);
      bctx.fillStyle = p.c + p.a + ")";
      bctx.fill();
    }

    const g = bctx.createRadialGradient(W*0.55, H*0.12, 10, W*0.55, H*0.12, Math.max(W,H)*0.6);
    g.addColorStop(0, "rgba(37,214,255,0.06)");
    g.addColorStop(0.25, "rgba(255,43,214,0.05)");
    g.addColorStop(0.55, "rgba(182,255,43,0.035)");
    g.addColorStop(1, "rgba(0,0,0,0)");
    bctx.fillStyle = g;
    bctx.fillRect(0,0,W,H);
  }

  // ============================================================
  // Init logs
  // ============================================================
  termPush("Boot sequence started...");
  termPush("Neon Core online.");
  termPush("Awaiting operator input.");

  // ============================================================
  // Game init sequence
  // ============================================================
  loadGame();
  recomputeGPS();
  rebuildSatellites();
  renderShop();
  updatePrestigeHUD();

  // Offline progress modal (after load/recompute)
  applyOfflineProgress();

  // Always update last seen immediately, so refresh doesn't double count
  localStorage.setItem(LAST_SEEN_KEY, String(Date.now()));

  // ============================================================
  // Golden glitch schedule
  // ============================================================
  scheduleNextGlitch(performance.now());

  // ============================================================
  // Main loop
  // ============================================================
  let lastShopRefresh = 0;
  let lastAutoSave = 0;

  function loop(){
    requestAnimationFrame(loop);

    const now = performance.now();
    const dt = (now - game.lastTick) / 1000;
    game.lastTick = now;

    // idle income
    if(game.gps > 0){
      game.money += game.gps * dt;
    }

    // smooth counting
    const diff = game.money - game.shownMoney;
    game.shownMoney += diff * (1 - Math.pow(0.001, dt));

    ui.moneyText.textContent = format(game.shownMoney);
    ui.gpsText.innerHTML = `GPS: ${format(game.gps)} /s<br/><span id="prestigeTextInline">BIT CORE: ${game.bitCore} (BONUS +${prestigeBonusPercent()}%)</span>`;
    // keep the dedicated prestigeText in sync too (not strictly needed but nice)
    updatePrestigeHUD();

    // refresh shop
    if(now - lastShopRefresh > 250){
      renderShop();
      lastShopRefresh = now;
    }

    // autosave
    if(now - lastAutoSave > 10000){
      saveGame();
      lastAutoSave = now;
    }

    // terminal random logs
    tickRandomLog(now);

    // background + satellites
    drawBackground();
    updateSatellites(now / 1000);

    // golden glitch timing
    if(!glitch.active && now >= glitch.nextSpawnAt){
      spawnGlitch(now);
    }
    if(glitch.active && now >= glitch.despawnAt){
      despawnGlitch();
      scheduleNextGlitch(now);
      ui.statusText.textContent = "GLITCH MISSED • STABILITY RESTORED";
      termPush("Golden Glitch vanished.");
    }
  }

  loop();
})();
</script>
</body>
</html>
